@model IEnumerable<QuanLyThueXe.Models.Car>
@using QuanLyThueXe.Helpers

@{
    ViewData["Title"] = "Tra c·ª©u t√¨nh tr·∫°ng xe";
    var totalCars = ViewBag.TotalCars as int? ?? 0;
    var availableCars = ViewBag.AvailableCars as int? ?? 0;
    var rentedCars = ViewBag.RentedCars as int? ?? 0;
    var pendingReservations = ViewBag.PendingReservations as int? ?? 0;
    var activeContracts = ViewBag.ActiveContracts as int? ?? 0;
    var activeContractsList = ViewBag.ActiveContractsList as IEnumerable<QuanLyThueXe.Models.Contract>;
    var pendingReservationsList = ViewBag.PendingReservationsList as IEnumerable<QuanLyThueXe.Models.Reservation>;
}

<div class="container-fluid mt-4">
    <h2 class="mb-4">üöó Tra c·ª©u t√¨nh tr·∫°ng xe</h2>

    <!-- Th·ªëng k√™ t·ªïng quan -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">T·ªïng s·ªë xe</h5>
                    <h2 class="mb-0">@totalCars</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Xe c√≥ s·∫µn</h5>
                    <h2 class="mb-0">@availableCars</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h5 class="card-title">Xe ƒëang thu√™</h5>
                    <h2 class="mb-0">@rentedCars</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">ƒê∆°n ch·ªù duy·ªát</h5>
                    <h2 class="mb-0">@pendingReservations</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Form t√¨m ki·∫øm v√† l·ªçc -->
    <div class="card mb-4 shadow">
        <div class="card-body">
            <form method="get" asp-action="Index" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">T√¨m ki·∫øm</label>
                    <input type="text" name="searchTerm" class="form-control" 
                           placeholder="Bi·ªÉn s·ªë, h√£ng, model..." 
                           value="@ViewBag.SearchTerm" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tr·∫°ng th√°i</label>
                    <select name="statusFilter" class="form-select">
                        <option value="All" selected="@(ViewBag.StatusFilter == "All")">T·∫•t c·∫£</option>
                        <option value="Available" selected="@(ViewBag.StatusFilter == "Available")">C√≥ s·∫µn</option>
                        <option value="Rented" selected="@(ViewBag.StatusFilter == "Rented")">ƒêang thu√™</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Lo·∫°i xe</label>
                    <select name="vehicleTypeFilter" class="form-select">
                        <option value="All" selected="@(ViewBag.VehicleTypeFilter == "All")">T·∫•t c·∫£</option>
                        <option value="Car" selected="@(ViewBag.VehicleTypeFilter == "Car")">√î t√¥</option>
                        <option value="Motorbike" selected="@(ViewBag.VehicleTypeFilter == "Motorbike")">Xe m√°y</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">üîç T√¨m ki·∫øm</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Danh s√°ch xe -->
    <div class="card shadow mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">üìã Danh s√°ch xe (@Model.Count())</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>·∫¢nh</th>
                            <th>Bi·ªÉn s·ªë</th>
                            <th>H√£ng/Model</th>
                            <th>Lo·∫°i</th>
                            <th>Gi√°/ng√†y</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>H·ª£p ƒë·ªìng ƒëang ho·∫°t ƒë·ªông</th>
                            <th>ƒê∆°n ƒë·∫∑t ch·ªù</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var car in Model)
                            {
                                var activeContract = car.Contracts?.FirstOrDefault(c => c.Status == "Active");
                                var pendingReservation = car.Reservations?.FirstOrDefault(r => r.Status == "Pending");
                                
                                <tr>
                                    <td>
                                        <img src="@ImageHelper.GetCarImageUrl(car)" 
                                             alt="@car.Brand @car.Model" 
                                             class="img-thumbnail" 
                                             style="width: 80px; height: 60px; object-fit: cover;" />
                                    </td>
                                    <td><strong>@car.LicensePlate</strong></td>
                                    <td>@car.Brand @car.Model</td>
                                    <td>
                                        <span class="badge bg-info">@car.VehicleType</span>
                                    </td>
                                    <td>@PriceHelper.FormatPrice(car.PricePerDay)</td>
                                    <td>
                                        @if (car.Status == "Available")
                                        {
                                            <span class="badge bg-success">C√≥ s·∫µn</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">ƒêang thu√™</span>
                                        }
                                    </td>
                                    <td>
                                        @if (activeContract != null)
                                        {
                                            <div class="small">
                                                <strong>KH:</strong> @activeContract.Customer?.FullName<br />
                                                <strong>T·ª´:</strong> @DateHelper.FormatDateOnly(activeContract.StartDate)<br />
                                                <strong>ƒê·∫øn:</strong> @DateHelper.FormatDateOnly(activeContract.EndDate)
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (pendingReservation != null)
                                        {
                                            <span class="badge bg-warning">
                                                @pendingReservation.Customer?.FullName
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <a asp-controller="Car" asp-action="Details" asp-route-id="@car.CarId" 
                                           class="btn btn-sm btn-outline-primary">Chi ti·∫øt</a>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <p class="text-muted mb-0">Kh√¥ng t√¨m th·∫•y xe n√†o</p>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- H·ª£p ƒë·ªìng ƒëang ho·∫°t ƒë·ªông -->
    @if (activeContractsList != null && activeContractsList.Any())
    {
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">üìÑ H·ª£p ƒë·ªìng ƒëang ho·∫°t ƒë·ªông (@activeContractsList.Count())</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>M√£ Hƒê</th>
                                <th>Xe</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>Ng√†y thu√™</th>
                                <th>Ng√†y tr·∫£</th>
                                <th>T·ªïng ti·ªÅn</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var contract in activeContractsList)
                            {
                                <tr>
                                    <td><strong>#@contract.ContractId</strong></td>
                                    <td>@contract.Car?.Brand @contract.Car?.Model (@contract.Car?.LicensePlate)</td>
                                    <td>@contract.Customer?.FullName</td>
                                    <td>@DateHelper.FormatDateOnly(contract.StartDate)</td>
                                    <td>@DateHelper.FormatDateOnly(contract.EndDate)</td>
                                    <td>@PriceHelper.FormatPrice(contract.TotalAmount)</td>
                                    <td>
                                        <a asp-controller="Contract" asp-action="Details" asp-route-id="@contract.ContractId" 
                                           class="btn btn-sm btn-outline-primary">Chi ti·∫øt</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- ƒê∆°n ƒë·∫∑t ch·ªù duy·ªát -->
    @if (pendingReservationsList != null && pendingReservationsList.Any())
    {
        <div class="card shadow mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">‚è≥ ƒê∆°n ƒë·∫∑t ch·ªù duy·ªát (@pendingReservationsList.Count())</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>M√£ ƒêƒê</th>
                                <th>Xe</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>Ng√†y ƒë·∫∑t</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var reservation in pendingReservationsList)
                            {
                                <tr>
                                    <td><strong>#@reservation.ReservationId</strong></td>
                                    <td>@reservation.Car?.Brand @reservation.Car?.Model (@reservation.Car?.LicensePlate)</td>
                                    <td>@reservation.Customer?.FullName</td>
                                    <td>@DateHelper.FormatDateTime(reservation.ReservationDate)</td>
                                    <td>
                                        <a asp-controller="Reservation" asp-action="Details" asp-route-id="@reservation.ReservationId" 
                                           class="btn btn-sm btn-outline-primary">Chi ti·∫øt</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <div class="mt-3">
        <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">
            ‚¨ÖÔ∏è Quay l·∫°i trang ch·ªß
        </a>
    </div>
</div>

