@model QuanLyThueXe.Models.Reservation
@using QuanLyThueXe.Helpers

@{
    ViewData["Title"] = "ƒê·∫∑t thu√™ xe";
    var selectedCar = ViewBag.SelectedCar as QuanLyThueXe.Models.Car;
    var customerName = ViewBag.CustomerName as string;
}

<div class="container mt-4">
    <h2 class="mb-4">üìù ƒê·∫∑t thu√™ xe</h2>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">
            @TempData["ErrorMessage"]
        </div>
    }

    @if (selectedCar != null)
    {
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">üöó Xe b·∫°n ƒë√£ ch·ªçn</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <img src="@ImageHelper.GetCarImageUrl(selectedCar)" 
                             alt="@selectedCar.Brand @selectedCar.Model" 
                             class="img-fluid rounded" 
                             style="max-height: 150px; object-fit: cover;" />
                    </div>
                    <div class="col-md-9">
                        <h5>@selectedCar.Brand @selectedCar.Model</h5>
                        <p class="mb-1"><strong>Bi·ªÉn s·ªë:</strong> @selectedCar.LicensePlate</p>
                        <p class="mb-1"><strong>Lo·∫°i xe:</strong> <span class="badge bg-info">@selectedCar.VehicleType</span></p>
                        <p class="mb-0"><strong>Gi√° thu√™:</strong> <span class="text-danger h5">@PriceHelper.FormatPrice(selectedCar.PricePerDay)</span>/ng√†y</p>
                    </div>
                </div>
            </div>
        </div>
    }

    <form asp-action="Create" method="post" class="card shadow">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Th√¥ng tin ƒë·∫∑t xe</h5>
        </div>
        <div class="card-body">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <input type="hidden" asp-for="ReservationId" />
            <input type="hidden" asp-for="Status" value="Pending" />

            @if (customerName != null)
            {
                <div class="alert alert-info">
                    <strong>Kh√°ch h√†ng:</strong> @customerName
                </div>
            }

            <div class="mb-3">
                <label asp-for="CustomerId" class="form-label">Kh√°ch h√†ng <span class="text-danger">*</span></label>
                <select asp-for="CustomerId" asp-items="ViewBag.CustomerId" class="form-select">
                    <option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
                </select>
                <span asp-validation-for="CustomerId" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="CarId" class="form-label">Xe thu√™ <span class="text-danger">*</span></label>
                <select asp-for="CarId" asp-items="ViewBag.CarId" class="form-select">
                    <option value="">-- Ch·ªçn xe --</option>
                </select>
                <span asp-validation-for="CarId" class="text-danger"></span>
                <small class="form-text text-muted">Ch·ªâ hi·ªÉn th·ªã c√°c xe ƒëang c√≥ s·∫µn</small>
            </div>

            <div class="mb-3">
                <label asp-for="ReservationDate" class="form-label">Ng√†y ƒë·∫∑t <span class="text-danger">*</span></label>
                <input asp-for="ReservationDate" type="datetime-local" class="form-control" 
                       value="@(Model.ReservationDate?.ToString("yyyy-MM-ddTHH:mm") ?? DateTime.Now.ToString("yyyy-MM-ddTHH:mm"))" />
                <span asp-validation-for="ReservationDate" class="text-danger"></span>
                <small class="form-text text-muted">Ng√†y b·∫°n mu·ªën b·∫Øt ƒë·∫ßu thu√™ xe</small>
            </div>

            <div class="alert alert-warning">
                <strong>üìå L∆∞u √Ω:</strong>
                <ul class="mb-0">
                    <li>ƒê∆°n ƒë·∫∑t xe c·ªßa b·∫°n s·∫Ω ·ªü tr·∫°ng th√°i <strong>"Ch·ªù duy·ªát"</strong></li>
                    <li>Nh√¢n vi√™n s·∫Ω li√™n h·ªá v·ªõi b·∫°n ƒë·ªÉ x√°c nh·∫≠n v√† ho√†n t·∫•t th·ªß t·ª•c</li>
                    <li>B·∫°n c√≥ th·ªÉ theo d√µi tr·∫°ng th√°i ƒë∆°n ƒë·∫∑t xe trong t√†i kho·∫£n c·ªßa m√¨nh</li>
                </ul>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-lg">
                    ‚úÖ G·ª≠i ƒë∆°n ƒë·∫∑t xe
                </button>
                <a asp-controller="Home" asp-action="Index" class="btn btn-secondary btn-lg">
                    ‚¨ÖÔ∏è Quay l·∫°i
                </a>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // T·ª± ƒë·ªông ch·ªçn xe n·∫øu c√≥ carId t·ª´ route
        @if (selectedCar != null)
        {
            <text>
            document.addEventListener('DOMContentLoaded', function() {
                var carSelect = document.getElementById('CarId');
                if (carSelect) {
                    carSelect.value = '@selectedCar.CarId';
                }
            });
            </text>
        }
    </script>
}

