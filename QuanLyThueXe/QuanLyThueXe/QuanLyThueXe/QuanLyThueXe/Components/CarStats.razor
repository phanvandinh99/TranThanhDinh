@using QuanLyThueXe.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@inject IServiceScopeFactory ServiceScopeFactory
@implements IAsyncDisposable

<div class="card mb-3">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">üìä Th·ªëng k√™ xe (Blazor Component)</h5>
    </div>
    <div class="card-body">
        @if (isLoading)
        {
            <p class="text-muted">ƒêang t·∫£i...</p>
        }
        else
        {
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="p-3 bg-light rounded">
                        <h3 class="text-primary">@totalCars</h3>
                        <p class="mb-0">T·ªïng s·ªë xe</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 bg-light rounded">
                        <h3 class="text-success">@availableCars</h3>
                        <p class="mb-0">Xe c√≥ s·∫µn</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 bg-light rounded">
                        <h3 class="text-warning">@rentedCars</h3>
                        <p class="mb-0">Xe ƒëang thu√™</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 bg-light rounded">
                        <h3 class="text-info">@motorbikeCount</h3>
                        <p class="mb-0">Xe m√°y</p>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-sm btn-outline-primary" @onclick="RefreshStats">
                    üîÑ L√†m m·ªõi
                </button>
                <span class="ms-2 text-muted small">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: @lastUpdate</span>
            </div>
        }
    </div>
</div>

@code {
    private int totalCars = 0;
    private int availableCars = 0;
    private int rentedCars = 0;
    private int motorbikeCount = 0;
    private bool isLoading = true;
    private string lastUpdate = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadStats();
        
        // T·ª± ƒë·ªông l√†m m·ªõi m·ªói 30 gi√¢y
        var timer = new System.Threading.Timer(async _ => await InvokeAsync(async () =>
        {
            await LoadStats();
            StateHasChanged();
        }), null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private async Task LoadStats()
    {
        try
        {
            isLoading = true;
            
            using var scope = ServiceScopeFactory.CreateScope();
            var dbContext = scope.ServiceProvider.GetRequiredService<CarRentalDbContext>();
            
            totalCars = await dbContext.Cars.CountAsync();
            availableCars = await dbContext.Cars.CountAsync(c => c.Status == "Available");
            rentedCars = await dbContext.Cars.CountAsync(c => c.Status == "Rented");
            motorbikeCount = await dbContext.Cars.CountAsync(c => c.VehicleType == "Motorbike");
            
            lastUpdate = DateTime.Now.ToString("HH:mm:ss");
        }
        catch (Exception ex)
        {
            // Log error n·∫øu c·∫ßn
            Console.WriteLine($"Error loading stats: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshStats()
    {
        await LoadStats();
    }

    public async ValueTask DisposeAsync()
    {
        // Cleanup n·∫øu c·∫ßn
        await Task.CompletedTask;
    }
}

